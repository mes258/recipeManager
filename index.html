<html>
  <head>
    <title>Grocery List</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="shortcut icon" href="#" />
  </head>

  <body>
    <div id="topBar">
      <input type="file" id="itemListFile"></input>
      <button id="loadLists">Load Lists</button>

      <button id="listTxt" onclick="downloadListTxt()">Download list txt</button>

    </div>
    <!-- The Modal -->
    <div id="myModal" class="modal">

      <!-- Modal content -->
      <div class="modal-content">
        <p id="modal-message">The following ingredients do not have saved sections. Please specify the section below.</p>
        <table id="modal-table">

        </table>
        <button id="addSection">Add Section</button>
      </div>

    </div>

    <div id="main">
      <div id="lists">
        <div id="recipeList"> 
          <table id="recipeTable">

          </table>
        </div>
        <div id="itemList">
          <table id="itemTable">

          </table>
        </div>
      </div>
      <div id="finalListDiv">
        <h3>The final list:</h3>
        <ul id="finalList">

        </ul>
      </div>
      <div id="addNew">
        <p>Add new recipe: </p>
        Name: <input id="newRecipeName" type="text"/>
        Link: <input id="newRecipeLink" type="text"/>
        Ingredients: <textarea id="newRecipeIng" name="text" rows="12" cols="50"></textarea>
        
        <button id="addNewRecipe">Add item</button>
        
        <p>Add new item: </p>
        Item: <input id="newItem" type="text"/>
        Section: <select id="newItemSection">
          <option value="Dairy">Dairy</option>
          <option value="Bakery">Bakery</option>
          <option value="Dry Goods">Dry Goods</option>
          <option value="Canned Goods">Canned Goods</option>
          <option value="Condiments and Spices">Condiments and Spices</option>
          <option value="Meat">Meat</option>
          <option value="Beverages">Beverages</option>
          <option value="Produce">Produce</option>
          <option value="Frozen">Frozen</option>
          <option value="Household Goods">Household Goods</option>
          <option value="Health and Beauty">Health and Beauty</option>
          <option value="Other">Other</option>
        </select>
        <button id="addNewItem">Add item</button>

      </div>
    </div>
    

  <script>
    var finalList = [];
    
    function itemBoxChanged(item){
      //console.log(itemStr)
      //var item = JSON.parse(itemStr);
      console.log(item)
      if (document.getElementById('itemBox'+item.id).checked) {
        finalList.push(item)
        var listItem = document.createElement('li');
        listItem.innerHTML = item.quantity + " " + item.name;
        listItem.id = "listItem" + item.id;

        var htmlList = document.getElementById('finalList');
        htmlList.appendChild(listItem);

      }else{
        console.log("UNchecked. id: " + item.id);
        finalList =  finalList.filter(data => data.id != item.id && data.name != item.name);

        var item = document.getElementById("listItem" + item.id);
        item.parentNode.removeChild(item);
      }
    }

    function recipeBoxChanged(recipe){
      console.log(recipe)
      if (document.getElementById('recipeBox'+recipe.id).checked) {
        finalList.push(recipe)
        
        var htmlList = document.getElementById('finalList');

        var numberOfIng = recipe.ingredients.length;
        var i;

        for (i = 0; i < numberOfIng; ++i) {

          var listItem = document.createElement('li');
          listItem.innerHTML = recipe.ingredients[i].quantity +" "+ recipe.ingredients[i].name;
          listItem.className = "recipe" + recipe.id + "ing";

          htmlList.appendChild(listItem);
        }
      }else{
        console.log("UNchecked. id: " + recipe.id);
        finalList =  finalList.filter(data => data.id != recipe.id && data.name != recipe.name);

        var ings = document.getElementsByClassName("recipe" + recipe.id + "ing");

        while(ings.length > 0){
          ings[0].parentNode.removeChild(ings[0]);
        }
      }
    }

    function sortBySections(ingList){
      //TODO: format by sections, combine ingredients
      //first sort by sections: 
      var sortedBySection = {};
      sections = [];

      for(var i = 0; i < ingList.length; ++i){
        var ing = ingList[i];
        if(sortedBySection[ing.section] != undefined){
          sortedBySection[ing.section].push(ing);
        }else{
          sortedBySection[ing.section] = [];
          sortedBySection[ing.section].push(ing);
          sections.push(ing.section);
        }
      }
      console.log(sortedBySection);
      console.log(sections)
      return {"sortedBySection": sortedBySection, "sections": sections};
    }

    function formatTxt(sectionInfo){
      sortedBySection = sectionInfo.sortedBySection;
      sections = sectionInfo.sections;
      var txtOutput = "";
      for(var i = 0; i < sections.length; ++i){
        txtOutput += "\n" + sections[i] + "\n";
        var ingsInSection = sortedBySection[sections[i]]
        for(var j = 0; j < ingsInSection.length; ++j){
          txtOutput += "\u2022" + ingsInSection[j].quantity + " " + ingsInSection[j].name + "\n";
        }
      }

      return txtOutput;
    }

    //then download.
    function downloadFile(text) {
        var fileDate = new Date();
        var filename = fileDate.getFullYear() + "-" + (fileDate.getMonth()+ 1) + "-" + fileDate.getDate() + "List.txt";
        var element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        element.setAttribute('download', filename);

        element.style.display = 'none';
        document.body.appendChild(element);

        element.click();

        document.body.removeChild(element);
    }

    function downloadListTxt(){
      var listWithRecipes = finalList;
      var ingList = [];

      //first only have ingredients in the list.
      //clean up this logic. 
      for(var i = 0; i < listWithRecipes.length; ++i){
        //this is not a great way to sort the items from recipes. maybe add types...
        if(listWithRecipes[i].section != undefined){
          //items: 
          ingList.push(listWithRecipes[i])
        }else{
          //recipes:
          for(var j = 0; j < listWithRecipes[i].ingredients.length; ++j){
            ingList.push(listWithRecipes[i].ingredients[j])
          }
        }
      }

      //second sort by sections:
      var sectionInfo = sortBySections(ingList);
      //third format (by txt)
      var text = formatTxt(sectionInfo);
      //finally, download
      downloadFile(text);

    }
  </script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="./client/socketScript.js"></script>
  <script type="module" src="./client/script.js"></script>
</body>

</html>